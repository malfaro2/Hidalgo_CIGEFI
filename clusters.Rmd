---
title: "Clusters"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(TSclust)
library(dplyr)
```

# Construcción de clusters con las observaciones de 74 estaciones en CA

Existen muchas opciones para agrupar los caudales de las estaciones, así que se elige trabajar con 3:

* Distancia univariada de las variancias de cada estación.
* k-means usando los primeros componentes de PCA. 
* Cluster para las series de tiempo utilizando https://www.jstatsoft.org/article/view/v062i01/v62i01.pdf


## Los datos

Los datos consisten en observaciones mensuales de cuadal en 74 estaciones: las fechas de observación van desde enero de 1969 hasta diciembre de 1979. Cada estación representa una cuenca hidrológica en Centro América, y en total se tienen observaciones de 12 meses en cada uno de los 11 años para 74 locaciones. También, se tienen datos de climatología mensual para cada una de las estaciones. 

```{r echo=FALSE}
caudal <- read.csv(file="obs74caudal.csv")
dim(caudal[,-c(1:3)])
clima <- read.csv(file="climatologia.csv")
dim(clima[,-1])
```

Las locaciones de las estaciones se pueden apreciar en el siguiente mapa:

```{r echo=FALSE, warning=FALSE}
loca <- read.csv(file="locations.csv")
dim(loca)
sbbox <- make_bbox(lon = loca$Longitud, lat = loca$Latitud, f = .1)
sbbox
sq_map <- get_map(location = sbbox, maptype = "terrain", source = "google")
ggmap(sq_map) + geom_point(data = loca, mapping = aes(x = Longitud, y = Latitud), color = "red")
```


## Clustering

* OPCIÓN 1: Utilizar las variancias y luego agrupar por magnitud.

```{r warning=FALSE}
aa<-round(c(apply(caudal[,-c(1:3)],2,var)),4)
loca$rank_var <- cut_number(aa,5)
sq_map <- get_map(location = sbbox, maptype = "satellite", source = "google")
ggmap(sq_map) + geom_point(data = loca, mapping = aes(x = Longitud, y = Latitud, colour=rank_var))
```

Descripción de los clusters:

```{r warning=FALSE}
medianas <- apply(caudal[,-c(1:3)],2,median)
data <- as_tibble(cbind(loca,medianas))
names(data) <- c("cod","lat","lon","area","rank_var","Mediana_de_cluster")
## Area promedio de cada cluster:
round(tapply(data$area, data$rank_var,mean),4)
## Mediana del Caudal de cada cluster:                                         
round(tapply(data$Mediana_de_cluster, data$rank_var,median),4)
```


* OPCIÓN 2: k-means usando los componentes de PCA. 

Primero, se deben calcular los PCA utilizando las anomalías en lugar de las observaciones. Como se tiene la climatología mensual para cada locación, el cálculo consiste en restar la climatología mensual a cada observación, según el mes correspondiente. Luego, se procede a hacer el PCA y por último agrupar las estaciones utilizando k-means de los primeros 10 componentes.

```{r warning=FALSE}
clima2 <- as.matrix(clima[,-1]) %x% rep(1, 11)
anomalies <- caudal[,-c(1:3)]-clima2
pc <- princomp(anomalies)
plot(pc)
mydata <- (pc$loadings[,1:10])
fit <- kmeans(mydata, 6) 
aggregate(mydata,by=list(fit$cluster),FUN=mean)
loca <- data.frame(loca, cluster=fit$cluster)
ggmap(sq_map) + geom_point(data = loca, mapping = aes(x = Longitud, y = Latitud, colour=as.character(cluster)))
```

Descripción de los clusters:

```{r warning=FALSE}
data <- as_tibble(cbind(loca,medianas))
names(data) <- c("cod","lat","lon","area","rank_var","cluster2","Mediana_de_cluster")
## Area promedio de cada cluster:
round(tapply(data$area, data$cluster2,mean),4)
## Medianan del Caudal de cada cluster:                                         
round(tapply(data$Mediana_de_cluster, data$cluster2,median),4)
```


* OPCIÓN 3: Cluster para las series de tiempo.

En este caso también se deben calcular las anomalías. Luego, se procede a aplicar el algoritmo de TSclust, que se describe aquí: https://www.jstatsoft.org/article/view/v062i01/v62i01.pdf 

```{r warning=FALSE}
dpred <- diss(anomalies, "ACF", p=0.05)
hc.pred <- hclust(dpred)
plot(hc.pred)
aa<-cutree(hc.pred, k = 6)
loca <- data.frame(loca, clusterTS=aa )
ggmap(sq_map) + geom_point(data = loca, mapping = aes(x = Longitud, y = Latitud, colour=as.character(clusterTS)))
```


Descripción de los clusters:

```{r warning=FALSE}
data <- as_tibble(cbind(loca,medianas))
names(data) <- c("cod","lat","lon","area","rank_var","cluster2","clusterTS", "Mediana_de_cluster")
## Area promedio de cada cluster:
round(tapply(data$area, data$clusterTS,mean),4)
## Mediana del Caudal de cada cluster:                                         
round(tapply(data$Mediana_de_cluster, data$cluster2,median),4)
```